name: Deploy to Cloudflare R2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install --legacy-peer-deps

      - name: Build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_CLOUDFLARE_D1_API_URL: ${{ secrets.VITE_CLOUDFLARE_D1_API_URL }}

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy index.html to R2
        run: wrangler r2 object put myeasyai-sites/red-purple-amora/index.html --file=dist/index.html --content-type="text/html" --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy assets to R2
        run: |
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            ext="${filename##*.}"
            case "$ext" in
              js) ct="application/javascript";;
              css) ct="text/css";;
              svg) ct="image/svg+xml";;
              png) ct="image/png";;
              jpg|jpeg) ct="image/jpeg";;
              woff2) ct="font/woff2";;
              woff) ct="font/woff";;
              *) ct="application/octet-stream";;
            esac
            echo "Uploading $filename with content-type $ct"
            wrangler r2 object put "myeasyai-sites/red-purple-amora/assets/$filename" --file="$file" --content-type="$ct" --remote
          done < <(find dist/assets -type f -print0)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Debug - List dist/avatar contents
        run: |
          echo "=== Checking dist/avatar structure ==="
          ls -la dist/ || echo "dist/ not found"
          ls -la dist/avatar/ || echo "dist/avatar/ not found"
          ls -la dist/avatar/models/ | head -20 || echo "dist/avatar/models/ not found"
          echo "=== Looking for Teleporter-Base.glb ==="
          find dist -name "*Teleporter*" -type f 2>/dev/null || echo "No Teleporter files found"

      - name: Deploy avatar files to R2
        run: |
          # Upload avatar models - use process substitution to avoid subshell issues
          echo "=== Starting avatar model upload ==="
          if [ -d "dist/avatar/models" ]; then
            echo "Found dist/avatar/models directory"
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              echo "Uploading avatar model: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="model/gltf-binary" --remote
            done < <(find dist/avatar/models -type f -name "*.glb" -print0)
          else
            echo "WARNING: dist/avatar/models directory not found!"
          fi

          # Upload avatar images
          echo "=== Starting avatar images upload ==="
          if [ -d "dist/avatar/images" ]; then
            echo "Found dist/avatar/images directory"
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              echo "Uploading: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done < <(find dist/avatar/images -type f -print0)
          else
            echo "WARNING: dist/avatar/images directory not found!"
          fi

          # Upload avatar thumbnails
          echo "=== Starting avatar thumbnails upload ==="
          if [ -d "dist/avatar/thumbnails" ]; then
            echo "Found dist/avatar/thumbnails directory"
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              echo "Uploading: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done < <(find dist/avatar/thumbnails -type f -print0)
          else
            echo "WARNING: dist/avatar/thumbnails directory not found!"
          fi
          echo "=== Avatar upload complete ==="
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
