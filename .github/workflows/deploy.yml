name: Deploy to Cloudflare R2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install --legacy-peer-deps

      - name: Build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_CLOUDFLARE_D1_API_URL: ${{ secrets.VITE_CLOUDFLARE_D1_API_URL }}

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy index.html to R2
        run: wrangler r2 object put myeasyai-sites/red-purple-amora/index.html --file=dist/index.html --content-type="text/html" --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy assets to R2
        run: |
          for file in dist/assets/*; do
            filename=$(basename "$file")
            ext="${filename##*.}"
            case "$ext" in
              js) ct="application/javascript";;
              css) ct="text/css";;
              svg) ct="image/svg+xml";;
              png) ct="image/png";;
              jpg|jpeg) ct="image/jpeg";;
              woff2) ct="font/woff2";;
              woff) ct="font/woff";;
              *) ct="application/octet-stream";;
            esac
            echo "Uploading $filename with content-type $ct"
            wrangler r2 object put "myeasyai-sites/red-purple-amora/assets/$filename" --file="$file" --content-type="$ct" --remote
          done
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy avatar files to R2
        run: |
          # Upload avatar models (using find to handle spaces in filenames)
          if [ -d "dist/avatar/models" ]; then
            find dist/avatar/models -type f -name "*.glb" -print0 | while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              echo "Uploading avatar model: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="model/gltf-binary" --remote
            done
          fi
          # Upload avatar images
          if [ -d "dist/avatar/images" ]; then
            find dist/avatar/images -type f -print0 | while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              echo "Uploading: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done
          fi
          # Upload avatar thumbnails
          if [ -d "dist/avatar/thumbnails" ]; then
            find dist/avatar/thumbnails -type f -print0 | while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              echo "Uploading: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
