name: Deploy to Cloudflare R2

on:
  push:
    branches:
      - main

jobs:
  # Job 1: Always runs - deploys main app files
  deploy-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: rm -rf node_modules package-lock.json && npm install --legacy-peer-deps

      - name: Build
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_CLOUDFLARE_D1_API_URL: ${{ secrets.VITE_CLOUDFLARE_D1_API_URL }}
          # VITE_GROQ_API_KEY: REMOVIDA - agora fica no Worker backend (wrangler secret put GROQ_API_KEY)
          VITE_STRIPE_PUBLISHABLE_KEY: ${{ secrets.VITE_STRIPE_PUBLISHABLE_KEY }}

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy index.html to R2
        run: wrangler r2 object put myeasyai-sites/red-purple-amora/index.html --file=dist/index.html --content-type="text/html" --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy assets to R2
        run: |
          while IFS= read -r -d '' file; do
            filename=$(basename "$file")
            ext="${filename##*.}"
            case "$ext" in
              js) ct="application/javascript";;
              css) ct="text/css";;
              svg) ct="image/svg+xml";;
              png) ct="image/png";;
              jpg|jpeg) ct="image/jpeg";;
              woff2) ct="font/woff2";;
              woff) ct="font/woff";;
              *) ct="application/octet-stream";;
            esac
            echo "Uploading $filename with content-type $ct"
            wrangler r2 object put "myeasyai-sites/red-purple-amora/assets/$filename" --file="$file" --content-type="$ct" --remote
          done < <(find dist/assets -type f -print0)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Check if avatar files changed in this commit
      - name: Check if avatar files changed
        id: avatar-changed
        run: |
          # Get list of changed files in this push
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")

          # Check if any avatar files changed
          if echo "$CHANGED_FILES" | grep -q "^public/avatar/"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Avatar files changed - will upload"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No avatar files changed - skipping upload"
          fi

      - name: Deploy avatar files to R2 (only if changed)
        if: steps.avatar-changed.outputs.changed == 'true'
        run: |
          echo "=== Starting avatar upload (files changed) ==="

          # Upload avatar models
          if [ -d "dist/avatar/models" ]; then
            echo "Uploading avatar models..."
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              echo "Uploading: $relpath"
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="model/gltf-binary" --remote
            done < <(find dist/avatar/models -type f -name "*.glb" -print0)
          fi

          # Upload avatar images
          if [ -d "dist/avatar/images" ]; then
            echo "Uploading avatar images..."
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done < <(find dist/avatar/images -type f -print0)
          fi

          # Upload avatar thumbnails
          if [ -d "dist/avatar/thumbnails" ]; then
            echo "Uploading avatar thumbnails..."
            while IFS= read -r -d '' file; do
              relpath="${file#dist/}"
              ext="${file##*.}"
              case "$ext" in
                png) ct="image/png";;
                jpg|jpeg) ct="image/jpeg";;
                webp) ct="image/webp";;
                *) ct="application/octet-stream";;
              esac
              wrangler r2 object put "myeasyai-sites/red-purple-amora/$relpath" --file="$file" --content-type="$ct" --remote
            done < <(find dist/avatar/thumbnails -type f -print0)
          fi

          # Upload render.html and thumbnail-renderer.html
          if [ -f "dist/avatar/render.html" ]; then
            wrangler r2 object put "myeasyai-sites/red-purple-amora/avatar/render.html" --file="dist/avatar/render.html" --content-type="text/html" --remote
          fi
          if [ -f "dist/avatar/thumbnail-renderer.html" ]; then
            wrangler r2 object put "myeasyai-sites/red-purple-amora/avatar/thumbnail-renderer.html" --file="dist/avatar/thumbnail-renderer.html" --content-type="text/html" --remote
          fi

          echo "=== Avatar upload complete ==="
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Skip avatar upload (no changes)
        if: steps.avatar-changed.outputs.changed == 'false'
        run: echo "Skipping avatar upload - no changes detected in public/avatar/"
